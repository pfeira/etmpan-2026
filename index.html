<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTOR 08 GRUPOS - ETMPAN</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0D47A1">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Teko:wght@500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0D47A1; --primary-hover: #1565C0;
            --secondary-color: #1976D2; --secondary-hover: #2196F3;
            --accent-color: #FF5722; --accent-hover: #F44336;
            --danger-color: #B71C1C; --warning-color: #E57373;
            --success-color: #28a745; --bg-color: #f7f8fc;
            --surface-color: #ffffff; --text-color: #424242;
            --text-muted: #6c757d; --border-color: #e0e0e0;
            --sidebar-bg: #ffffff; --sidebar-text: #424242;
            --font-primary: 'Roboto', sans-serif; --font-display: 'Teko', sans-serif;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
            --border-radius: 12px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-primary); background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; overflow-x: hidden; }
        h1, h2, h3 { font-family: var(--font-display); letter-spacing: 1px; color: var(--primary-color); }
        #app { display: flex; min-height: 100vh; }
        .container { display: flex; width: 100%; }
        .sidebar { width: 280px; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 24px; display: flex; flex-direction: column; gap: 20px; position: fixed; height: 100%; overflow-y: auto; border-right: 1px solid var(--border-color); }
        .main-content { flex-grow: 1; margin-left: 280px; padding: 24px 32px; display: flex; flex-direction: column; gap: 24px; }
        .sidebar-section { border-top: 1px solid var(--border-color); padding-top: 20px; }
        .sidebar-section h3 { color: var(--secondary-color); }
        .form-label, .pdf-section-title { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; color: var(--text-color); font-size: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2); }
        .pdf-buttons { display: flex; flex-direction: column; gap: 10px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 18px; font-size: 1rem; font-weight: 500; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease-out; position: relative; border: none; color: white; text-shadow: 0 1px 1px rgba(0,0,0,0.2); }
        .btn--primary { background: linear-gradient(145deg, #1565C0, #0D47A1); box-shadow: 0 4px 8px rgba(13, 71, 161, 0.3), inset 0 -2px 1px rgba(0,0,0,0.2); }
        .btn--primary:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(13, 71, 161, 0.3), inset 0 -2px 1px rgba(0,0,0,0.2); }
        .btn--primary:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 2px 4px rgba(13, 71, 161, 0.3), inset 0 -1px 1px rgba(0,0,0,0.2); }
        .btn--accent { background: linear-gradient(145deg, #FF5722, #F44336); box-shadow: 0 4px 8px rgba(255, 87, 34, 0.3), inset 0 -2px 1px rgba(0,0,0,0.2); }
        .btn--accent:hover:not(:disabled) { transform: translateY(-1px); box-shadow: 0 6px 12px rgba(255, 87, 34, 0.3), inset 0 -2px 1px rgba(0,0,0,0.2); }
        .btn--accent:active:not(:disabled) { transform: translateY(1px); box-shadow: 0 2px 4px rgba(255, 87, 34, 0.3), inset 0 -1px 1px rgba(0,0,0,0.2); }
        .btn--secondary { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); text-shadow: none; }
        .btn--secondary:hover:not(:disabled) { background-color: var(--bg-color); }
        .btn--sm { padding: 8px 12px; font-size: 0.9rem; }
        .btn--full-width { width: 100%; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn .btn-loading { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); }
        .hidden { display: none !important; }
        .phase-indicator { display: flex; justify-content: space-around; background: var(--surface-color); padding: 16px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        .phase { display: flex; align-items: center; gap: 10px; opacity: 0.5; position: relative; flex: 1; justify-content: center; }
        .phase:not(:last-child)::after { content: ''; position: absolute; right: -25%; top: 50%; width: 50%; height: 2px; background: var(--border-color); transform: translateY(-50%); }
        .phase-number { width: 32px; height: 32px; border-radius: 50%; background-color: var(--bg-color); border: 2px solid var(--border-color); color: var(--text-muted); display: grid; place-items: center; font-weight: bold; }
        .phase-name { font-weight: 500; }
        .phase.phase-active { opacity: 1; }
        .phase.phase-active .phase-number { border-color: var(--primary-color); color: var(--primary-color); }
        .phase.phase-complete .phase-number { border-color: var(--success-color); background-color: var(--success-color); color: white; }
        .phase-content { background: var(--surface-color); padding: 24px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
        .phase-content h2 { font-size: 2rem; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .athletes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .athlete-input-group { display: flex; align-items: center; }
        .athlete-input-group span { padding: 8px; background: var(--bg-color); border: 1px solid var(--border-color); border-right: none; border-top-left-radius: 8px; border-bottom-left-radius: 8px; font-weight: 500; }
        .athlete-input-group input { flex-grow: 1; padding: 8px; border: 1px solid var(--border-color); border-radius: 0; border-top-right-radius: 8px; border-bottom-right-radius: 8px; }
        .groups-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
        .group-card { border: 1px solid var(--border-color); border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        .group-card h4 { background: var(--primary-color); color: white; padding: 12px; border-bottom: 1px solid var(--border-color); border-top-left-radius: var(--border-radius); border-top-right-radius: var(--border-radius); }
        .group-card ul { list-style: none; padding: 12px; }
        .group-card li { padding: 4px 0; }
        .group-card li:nth-child(odd) { background-color: var(--bg-color); }
        .group-card li span { display: inline-block; width: 25px; font-weight: 500; color: var(--text-muted); }
        .groups-tabs .tabs { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-color); }
        .tab { padding: 10px 16px; cursor: pointer; border: 1px solid transparent; border-bottom: none; border-radius: var(--border-radius) var(--border-radius) 0 0; }
        .tab:hover { background-color: var(--bg-color); }
        .tab.active { background-color: var(--surface-color); border-color: var(--border-color); border-bottom-color: var(--surface-color); position: relative; top: 1px; font-weight: 500; color: var(--primary-color); }
        .group-content { display: grid; grid-template-columns: 2fr 3fr; gap: 24px; }
        .matches-container h4, .standings-container h4 { margin-bottom: 12px; font-size: 1.2rem; }
        .match-card { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid var(--border-color); border-radius: var(--border-radius); margin-bottom: 10px; cursor: pointer; transition: all 0.2s; }
        .match-card:hover { box-shadow: var(--shadow-sm); border-color: var(--secondary-color); }
        .match-card.played { background-color: #e8f5e9; cursor: default; }
        .match-players { text-align: center; flex-grow: 1; }
        .match-result { font-weight: bold; font-family: var(--font-display); font-size: 1.5rem; }
        .standings-table { width: 100%; border-collapse: collapse; }
        .standings-table th, .standings-table td { padding: 10px; text-align: center; border-bottom: 1px solid var(--border-color); }
        .standings-table th { background: var(--bg-color); font-weight: 500; }
        .standings-table td:first-child { text-align: left; }
        .standings-table tr:nth-child(1) td, .standings-table tr:nth-child(2) td { background-color: #E3F2FD; }
        .elimination-container { display: flex; gap: 32px; overflow-x: auto; padding: 16px; background-color: var(--bg-color); border-radius: var(--border-radius); }
        .elimination-side { flex: 1; min-width: 500px; }
        .elimination-side > h3 { text-align: center; margin-bottom: 16px; font-size: 2rem; }
        .elimination-rounds { display: flex; gap: 20px; padding-bottom: 16px; }
        .round { display: flex; flex-direction: column; gap: 30px; min-width: 280px; flex: 1; }
        .round h4 { text-align: center; font-size: 1.5rem; color: var(--secondary-color); }
        .elim-match { background-color: var(--surface-color); border-radius: var(--border-radius); border: 1px solid var(--border-color); cursor: pointer; box-shadow: var(--shadow-sm); }
        .elim-match.played { cursor: default; }
        .elim-match.winner .player-name { font-weight: bold; color: var(--success-color); }
        .elim-match-player { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; }
        .elim-match-player:first-child { border-bottom: 1px solid var(--border-color); }
        .player-name { flex-grow: 1; font-size: 0.9rem; }
        .player-score { font-weight: bold; }
        .final-match-container { margin-top: 32px; padding-top: 24px; border-top: 2px dashed var(--accent-color); }
        .final-match-container h3 { text-align: center; font-size: 2rem; color: var(--accent-color); }
        .final-match-container .round { justify-content: center; margin: 0 auto; }
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 40px 0; text-align: center; }
        .position { width: 200px; padding: 20px; border-radius: var(--border-radius); background: var(--surface-color); box-shadow: var(--shadow-md); }
        .position .athlete-name { font-size: 1.2rem; font-weight: 500; margin: 10px 0; }
        .position .points { font-size: 1.2rem; color: var(--text-muted); font-family: var(--font-display); }
        #champion { order: 2; height: 200px; }
        #runnerup { order: 1; height: 160px; }
        #third-place-container { order: 3; display: flex; gap: 10px; align-items: flex-end; }
        #third-place-container .position { width: 160px; height: 130px; }
        #third-place-container .athlete-name { font-size: 1rem; }
        .medal { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto; border: 3px solid; }
        .gold { background: #ffd700; border-color: #e6c200; }
        .silver { background: #c0c0c0; border-color: #ababab; }
        .bronze { background: #cd7f32; border-color: #b8722d; }
        .ranking-table { width: 100%; border-collapse: collapse; }
        .ranking-table th, .ranking-table td { padding: 12px; text-align: left; border-bottom: 1px solid var(--border-color); }
        .ranking-table th { background: var(--bg-color); }
        .ranking-table tr:nth-child(-n+4) { font-weight: bold; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: var(--surface-color); border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: var(--shadow-md); animation: slide-down 0.3s ease-out; }
        @keyframes slide-down { from { transform: translateY(-30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-muted); }
        .modal-body { padding: 24px; }
        .match-info { display: flex; justify-content: space-around; align-items: center; margin-bottom: 24px; }
        .match-info .athlete { font-size: 1.5rem; font-weight: 500; font-family: var(--font-display); }
        .vs { font-size: 1.2rem; color: var(--text-muted); }
        .sets-input h4 { text-align: center; margin-bottom: 16px; font-weight: 500; }
        .sets-grid { display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; gap: 10px 20px; }
        .sets-grid > div { text-align: center; font-weight: 500; padding-bottom: 8px; }
        .set-input { width: 100%; padding: 8px; text-align: center; border: 1px solid var(--border-color); border-radius: var(--border-radius); font-size: 1.2rem; }
        .modal-result { text-align: center; font-size: 1.2rem; font-weight: 500; margin-top: 20px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
        .pdf-toast { position: fixed; bottom: 20px; right: 20px; background-color: var(--sidebar-bg); color: var(--sidebar-text); padding: 16px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); z-index: 2000; animation: fade-in 0.5s; }
        .pdf-toast.hidden { display: none; }
        @keyframes fade-in { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .toast-content { display: flex; align-items: center; gap: 12px; }
        .toast-icon svg { color: var(--accent-color); }
        .pdf-toast.info .toast-icon svg { color: var(--primary-color); }
        @media (max-width: 1300px) { .groups-grid { grid-template-columns: repeat(2, 1fr); } }
        @media (max-width: 1200px) { .group-content { grid-template-columns: 1fr; } .elimination-container { flex-direction: column; } .elimination-side { min-width: 100%; } }
        @media (max-width: 768px) { .container { flex-direction: column; } .sidebar { position: static; width: 100%; height: auto; overflow-y: visible; } .main-content { margin-left: 0; } .phase-name { display: none; } .phase:not(:last-child)::after { right: -50%; width: 100%; } .groups-grid { grid-template-columns: 1fr; } .elimination-rounds { flex-direction: column; gap: 10px; } .round { gap: 10px; } }
        
        #login-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-color);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-box {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background-color: var(--surface-color);
            box-shadow: var(--shadow-md);
            border-radius: var(--border-radius);
            text-align: center;
        }
        .login-box .form-control {
            margin-bottom: 16px;
        }
        #login-error {
            color: var(--danger-color);
            margin-top: 10px;
            font-size: 0.9rem;
            height: 1.2rem;
        }
    </style>
</head>
<body>
    <div id="login-screen">
        <div class="login-box">
            <img src="etmpan1.jpg.jpg" alt="Logo ETMPAN" style="width: 100px; height: auto; margin-bottom: 1rem; border-radius: 8px;">
            <h2 style="font-size: 2.5rem; margin-bottom: 2rem;">Acesso ao Gestor</h2>
            <input type="text" id="username" class="form-control" placeholder="Usuário">
            <input type="password" id="password" class="form-control" placeholder="Senha">
            <button id="loginBtn" class="btn btn--primary btn--full-width">Entrar</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="container">
            <aside class="sidebar">
                 <div class="text-center mb-4">
                    <img src="etmpan1.jpg.jpg" alt="Logo ETMPAN" class="w-28 h-auto mx-auto rounded-lg">
                    <h1 class="text-4xl font-bold text-[--primary-color] font-['Teko'] tracking-wider mt-2">GESTOR 08</h1>
                </div>
                
                <div class="sidebar-section">
                    <label for="divisionSelector" class="form-label">Divisão Ativa</label>
                    <select id="divisionSelector" class="form-control">
                        <option value="1ª Div.">1ª Div.</option>
                        <option value="2ª Div.">2ª Div.</option>
                        <option value="3ª Div.">3ª Div.</option>
                    </select>
                </div>

                <div class="sidebar-section">
                    <label for="tournamentName" class="form-label">Nome do Torneio</label>
                    <input type="text" id="tournamentName" class="form-control" placeholder="Digite o nome do torneio">
                </div>
                
                <div class="sidebar-section">
                    <h3 class="pdf-section-title">Exportar PDFs</h3>
                    <div class="pdf-buttons">
                        <button id="exportSetupBtn" class="btn btn--primary btn--sm btn--full-width" disabled>Lista de Inscritos</button>
                        <button id="exportGroupsBtn" class="btn btn--primary btn--sm btn--full-width" disabled>Grupos e Chaves</button>
                        <button id="exportBracketBtn" class="btn btn--primary btn--sm btn--full-width" disabled>Chave Eliminatória</button>
                        <button id="exportRankingsBtn" class="btn btn--primary btn--sm btn--full-width" disabled>Ranking Final</button>
                        <button id="exportCompleteBtn" class="btn btn--accent btn--sm btn--full-width" disabled>Relatório Completo</button>
                        <button id="exportSumulasBtn" class="btn btn--secondary btn--sm btn--full-width" disabled>Súmulas dos Grupos</button>
                        <button id="exportSumulaEliminatoriaBtn" class="btn btn--secondary btn--sm btn--full-width" disabled>Súmulas Eliminatórias</button>
                        <button id="exportSumulaFinalBtn" class="btn btn--secondary btn--sm btn--full-width" disabled>Súmula da Final</button>
                    </div>
                </div>
                
                <div class="sidebar-section">
                    <button id="resetBtn" class="btn btn--secondary btn--full-width">Resetar Torneio Atual</button>
                    <button id="logoutBtn" class="btn btn--secondary btn--full-width" style="margin-top: 10px; border-color: var(--warning-color); color: var(--danger-color);">Sair (Logout)</button>
                </div>
            </aside>
            
            <main class="main-content">
                <div class="phase-indicator">
                    <div class="phase phase-active" data-phase="setup"><span class="phase-number">1</span><span class="phase-name">Configuração</span></div>
                    <div class="phase" data-phase="groups"><span class="phase-number">2</span><span class="phase-name">Fase de Grupos</span></div>
                    <div class="phase" data-phase="elimination"><span class="phase-number">3</span><span class="phase-name">Eliminatórias</span></div>
                    <div class="phase" data-phase="results"><span class="phase-number">4</span><span class="phase-name">Resultados</span></div>
                </div>
                
                <section id="setup-phase" class="phase-content active">
                    <h2>Configuração do Torneio</h2>
                    <div class="setup-form">
                        <h3>Cadastro de Atletas (24 posições por ranking)</h3>
                        <div class="athletes-grid" id="athletesGrid"></div>
                        <button id="generateGroupsBtn" class="btn btn--primary">Gerar Grupos</button>
                    </div>
                    <div id="groupsDisplay" class="groups-display hidden">
                        <h3>Distribuição dos Grupos</h3>
                        <div class="groups-grid" id="groupsGrid"></div>
                        <button id="startTournamentBtn" class="btn btn--accent">Iniciar Torneio</button>
                    </div>
                </section>
                
                <section id="groups-phase" class="phase-content hidden">
                    <h2>Fase de Grupos</h2>
                    <div class="groups-tabs"><div class="tabs" id="groupTabs"></div></div>
                    <div class="group-content">
                        <div id="groupMatches" class="matches-container"></div>
                        <div id="groupStandings" class="standings-container"></div>
                    </div>
                    <button id="finishGroupsBtn" class="btn btn--primary hidden" style="margin-top: 20px;">Finalizar Fase de Grupos</button>
                </section>
                
                <section id="elimination-phase" class="phase-content hidden">
                    <h2>Fase Eliminatória</h2>
                    <div class="elimination-container">
                        <div class="elimination-side" id="sideA">
                            <h3>LADO A</h3>
                            <div class="elimination-rounds">
                                <div class="round" id="roundA-QF"><h4>Quartas de Final</h4><div class="matches" id="matchesA-QF"></div></div>
                                <div class="round" id="roundA-SF"><h4>Semifinais</h4><div class="matches" id="matchesA-SF"></div></div>
                                <div class="round" id="roundA-F"><h4>Final Lado A</h4><div class="matches" id="matchesA-F"></div></div>
                            </div>
                        </div>
                        <div class="elimination-side" id="sideB">
                            <h3>LADO B</h3>
                            <div class="elimination-rounds">
                                <div class="round" id="roundB-QF"><h4>Quartas de Final</h4><div class="matches" id="matchesB-QF"></div></div>
                                <div class="round" id="roundB-SF"><h4>Semifinais</h4><div class="matches" id="matchesB-SF"></div></div>
                                <div class="round" id="roundB-F"><h4>Final Lado B</h4><div class="matches" id="matchesB-F"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="final-match-container">
                        <h3>FINAL GERAL</h3>
                        <div class="elimination-rounds"><div class="round" id="roundFinal"><div class="matches" id="matchesFinal"></div></div></div>
                    </div>
                </section>
                
                <section id="results-phase" class="phase-content hidden">
                    <h2>Resultados Finais</h2>
                    <div class="final-results">
                        <div class="podium">
                             <div class="position" id="runnerup"><div class="medal silver"></div><div class="athlete-name">Vice-Campeão</div><div class="points"></div></div>
                            <div class="position" id="champion"><div class="medal gold"></div><div class="athlete-name">Campeão</div><div class="points"></div></div>
                            <div id="third-place-container">
                                <div class="position" id="third-a"><div class="medal bronze"></div><div class="athlete-name">3º Lugar</div><div class="points"></div></div>
                                 <div class="position" id="third-b"><div class="medal bronze"></div><div class="athlete-name">3º Lugar</div><div class="points"></div></div>
                            </div>
                        </div>
                        <div class="final-ranking">
                            <h3>Classificação Final</h3>
                            <table class="ranking-table" id="finalRanking"></table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
        
        <div id="matchModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h3 id="modalTitle">Resultado da Partida</h3><button class="modal-close" id="closeModal">&times;</button></div>
                <div class="modal-body">
                    <div class="match-info"><div class="athlete" id="modalAthlete1"></div><div class="vs">VS</div><div class="athlete" id="modalAthlete2"></div></div>
                    <div class="sets-input"><h4>Resultado por Sets (Melhor de 5)</h4><div class="sets-grid" id="setsGrid"></div></div>
                    <div class="modal-result" id="modalResult"></div>
                </div>
                <div class="modal-footer"><button id="saveResult" class="btn btn--primary">Salvar</button><button id="cancelResult" class="btn btn--secondary">Cancelar</button></div>
            </div>
        </div>
        <div id="genericModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h3 id="genericModalTitle">Atenção</h3><button class="modal-close" id="genericModalClose">&times;</button></div>
                <div class="modal-body"><p id="genericModalMessage"></p></div>
                <div class="modal-footer" id="genericModalFooter"><button id="genericModalConfirmBtn" class="btn btn--primary">Confirmar</button><button id="genericModalCancelBtn" class="btn btn--secondary">Cancelar</button></div>
            </div>
        </div>
        <div id="pdfToast" class="pdf-toast hidden">
            <div class="toast-content">
                <div class="toast-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg></div>
                <div class="toast-message" id="toastMessage"></div>
            </div>
        </div>
    </div>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const APP_VERSION = "2.1"; 
        let appState = {}; 
        let state = {}; 

        function getInitialTournamentState(division) {
            return {
                appVersion: APP_VERSION, tournamentName: '', division: division,
                currentPhase: 'setup', athletes: [], groups: {}, groupMatches: {}, standings: {},
                elimination: { qualifiers: [], sideA: { quarterfinals: [], semifinals: [], final: [] }, sideB: { quarterfinals: [], semifinals: [], final: [] }, overallFinal: [] },
                activeGroupTab: 'A', currentMatch: null,
            };
        }

        function getInitialAppState() {
            return {
                appVersion: APP_VERSION, loggedIn: false, activeDivision: '1ª Div.',
                tournaments: {
                    '1ª Div.': getInitialTournamentState('1ª Div.'),
                    '2ª Div.': getInitialTournamentState('2ª Div.'),
                    '3ª Div.': getInitialTournamentState('3ª Div.'),
                }
            };
        }

        const NUM_ATHLETES = 24;
        const NUM_GROUPS = 8;
        const GROUP_NAMES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
        const POINTS_CONFIG = {
            '1ª Div.': { CHAMPION: 265, RUNNER_UP: 260, SEMIFINALS: 250, QUARTERFINALS: 235, ROUND_16: 215, GROUP_STAGE: 190 },
            '2ª Div.': { CHAMPION: 190, RUNNER_UP: 185, SEMIFINALS: 175, QUARTERFINALS: 160, ROUND_16: 140, GROUP_STAGE: 115 },
            '3ª Div.': { CHAMPION: 115, RUNNER_UP: 110, SEMIFINALS: 100, QUARTERFINALS: 85, ROUND_16: 65, GROUP_STAGE: 40 },
            BONUS: { '3-0': { winner: 5, loser: 0 }, '3-1': { winner: 4, loser: 1 }, '3-2': { winner: 3, loser: 2 } }
        };

        const loginScreen = document.getElementById('login-screen');
        const appContainer = document.getElementById('app');
        const loginBtn = document.getElementById('loginBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const divisionSelector = document.getElementById('divisionSelector');
        const tournamentNameInput = document.getElementById('tournamentName');
        const athletesGrid = document.getElementById('athletesGrid');
        const generateGroupsBtn = document.getElementById('generateGroupsBtn');
        const groupsDisplay = document.getElementById('groupsDisplay');
        const groupsGrid = document.getElementById('groupsGrid');
        const startTournamentBtn = document.getElementById('startTournamentBtn');
        const phaseIndicator = document.querySelector('.phase-indicator');
        const phaseContents = document.querySelectorAll('.phase-content');
        const groupTabsContainer = document.getElementById('groupTabs');
        const groupMatchesContainer = document.getElementById('groupMatches');
        const groupStandingsContainer = document.getElementById('groupStandings');
        const finishGroupsBtn = document.getElementById('finishGroupsBtn');
        const matchModal = document.getElementById('matchModal');
        const closeModalBtn = document.getElementById('closeModal');
        const cancelResultBtn = document.getElementById('cancelResult');
        const saveResultBtn = document.getElementById('saveResult');
        const resetBtn = document.getElementById('resetBtn');
        
        function initAuth() {
            loadState(); 
            if (appState.loggedIn) {
                loginScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                init();
            } else {
                loginScreen.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        }

        function handleLogin() {
            const user = document.getElementById('username').value;
            const pass = document.getElementById('password').value;
            const errorEl = document.getElementById('login-error');
            if (user === 'admin' && pass === 'admin123') {
                appState.loggedIn = true;
                saveState();
                initAuth();
            } else {
                errorEl.textContent = 'Usuário ou senha inválidos.';
            }
        }

        function handleLogout() {
            appState.loggedIn = false;
            saveState();
            initAuth();
        }

        loginBtn.addEventListener('click', handleLogin);
        document.getElementById('password').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleLogin();
        });
        logoutBtn.addEventListener('click', handleLogout);

        function saveState() { localStorage.setItem('gestorAppState', JSON.stringify(appState)); }
        function loadState() {
            const savedStateJSON = localStorage.getItem('gestorAppState');
            if (savedStateJSON) {
                const savedState = JSON.parse(savedStateJSON);
                if (savedState.appVersion === APP_VERSION) {
                    appState = savedState;
                    return;
                }
            }
            appState = getInitialAppState();
        }
        
        function resetState() {
            showConfirm(`Tem certeza que deseja resetar o torneio da ${appState.activeDivision}? Todos os dados desta divisão serão perdidos.`, 'Resetar Torneio',
                () => {
                    appState.tournaments[appState.activeDivision] = getInitialTournamentState(appState.activeDivision);
                    saveState();
                    render();
                }
            );
        }
        resetBtn.addEventListener('click', resetState);

        function init() {
            state = appState.tournaments[appState.activeDivision];
            divisionSelector.value = appState.activeDivision;
            divisionSelector.addEventListener('change', (e) => {
                appState.activeDivision = e.target.value;
                saveState();
                init(); 
            });
            tournamentNameInput.addEventListener('input', (e) => {
                state.tournamentName = e.target.value;
                saveState();
            });
            render();
        }

        function render() {
            state = appState.tournaments[appState.activeDivision];
            tournamentNameInput.value = state.tournamentName;
            updatePhaseUI();
            switch (state.currentPhase) {
                case 'setup': initSetupPhase(); break;
                case 'groups': initGroupsPhase(); break;
                case 'elimination': initEliminationPhase(); break;
                case 'results': initResultsPhase(); break;
            }
            updatePdfButtons();
        }
        
        function updatePhaseUI() {
            phaseIndicator.querySelectorAll('.phase').forEach(phaseEl => {
                const phaseName = phaseEl.dataset.phase;
                phaseEl.classList.remove('phase-active', 'phase-complete');
                const phasesOrder = ['setup', 'groups', 'elimination', 'results'];
                const currentIndex = phasesOrder.indexOf(state.currentPhase);
                const phaseIndex = phasesOrder.indexOf(phaseName);
                if (phaseIndex < currentIndex) { phaseEl.classList.add('phase-complete'); } 
                else if (phaseIndex === currentIndex) { phaseEl.classList.add('phase-active'); }
            });
            phaseContents.forEach(content => {
                content.classList.add('hidden');
                if (content.id === `${state.currentPhase}-phase`) { content.classList.remove('hidden'); }
            });
        }
        
        function updatePdfButtons() {
            const isSetupDone = state.athletes.length === NUM_ATHLETES;
            const areGroupsDone = Object.keys(state.groups).length > 0;
            const isGroupPhaseDone = state.currentPhase === 'elimination' || state.currentPhase === 'results';
            const isEliminationDone = state.currentPhase === 'results';
            document.getElementById('exportSetupBtn').disabled = !isSetupDone;
            document.getElementById('exportGroupsBtn').disabled = !areGroupsDone;
            document.getElementById('exportSumulasBtn').disabled = !areGroupsDone;
            document.getElementById('exportBracketBtn').disabled = !isGroupPhaseDone;
            document.getElementById('exportSumulaEliminatoriaBtn').disabled = !isGroupPhaseDone;
            document.getElementById('exportSumulaFinalBtn').disabled = !isEliminationDone;
            document.getElementById('exportRankingsBtn').disabled = !isEliminationDone;
            document.getElementById('exportCompleteBtn').disabled = !isEliminationDone;
        }

        function initSetupPhase() {
            athletesGrid.innerHTML = '';
            for (let i = 0; i < NUM_ATHLETES; i++) {
                const athlete = state.athletes.find(a => a.rank === i + 1);
                athletesGrid.innerHTML += `<div class="athlete-input-group"><span>${i + 1}</span><input type="text" class="athlete-name-input" data-rank="${i + 1}" placeholder="Nome do Atleta ${i + 1}" value="${athlete ? athlete.name : ''}"></div>`;
            }
            if (Object.keys(state.groups).length > 0) {
                renderGroupsDisplay();
                groupsDisplay.classList.remove('hidden');
                generateGroupsBtn.classList.add('hidden');
            } else {
                 groupsDisplay.classList.add('hidden');
                 generateGroupsBtn.classList.remove('hidden');
            }
        }
        
        generateGroupsBtn.addEventListener('click', () => {
            state.athletes = [];
            const inputs = document.querySelectorAll('.athlete-name-input');
            let allFilled = true;
            inputs.forEach(input => {
                if (input.value.trim() === '') allFilled = false;
                state.athletes.push({ id: `athlete-${input.dataset.rank}`, name: input.value.trim() || `Atleta ${input.dataset.rank}`, rank: parseInt(input.dataset.rank) });
            });
            if (!allFilled) {
                showConfirm('Alguns nomes de atletas não foram preenchidos. Deseja continuar com nomes genéricos?', 'Atletas Incompletos', () => generateAndRenderGroups());
            } else {
                generateAndRenderGroups();
            }
        });

        function generateAndRenderGroups() { generateGroups(); renderGroupsDisplay(); groupsDisplay.classList.remove('hidden'); generateGroupsBtn.classList.add('hidden'); saveState(); updatePdfButtons(); }
        function generateGroups() {
            const getByRank = (rank) => state.athletes.find(a => a.rank === rank);
            state.groups = {
                'A': [getByRank(1), getByRank(16), getByRank(17)], 'B': [getByRank(2), getByRank(15), getByRank(18)], 'C': [getByRank(3), getByRank(14), getByRank(19)], 'D': [getByRank(4), getByRank(13), getByRank(20)],
                'E': [getByRank(5), getByRank(12), getByRank(21)], 'F': [getByRank(6), getByRank(11), getByRank(22)], 'G': [getByRank(7), getByRank(10), getByRank(23)], 'H': [getByRank(8), getByRank(9), getByRank(24)],
            };
        }
        function renderGroupsDisplay() {
            groupsGrid.innerHTML = '';
            GROUP_NAMES.forEach(name => {
                groupsGrid.innerHTML += `<div class="group-card"><h4>Grupo ${name}</h4><ul>${state.groups[name].map(a => `<li><span>${a.rank}º</span> ${a.name}</li>`).join('')}</ul></div>`;
            });
        }
        startTournamentBtn.addEventListener('click', () => { state.currentPhase = 'groups'; generateGroupMatchesAndStandings(); saveState(); render(); });
        function generateGroupMatchesAndStandings() {
            state.groupMatches = {}; state.standings = {};
            GROUP_NAMES.forEach(groupName => {
                const athletes = state.groups[groupName];
                state.groupMatches[groupName] = [
                    { id: `${groupName}-1`, p1: athletes[0].id, p2: athletes[2].id, score1: null, score2: null, sets: [] }, { id: `${groupName}-2`, p1: athletes[1].id, p2: athletes[2].id, score1: null, score2: null, sets: [] },
                    { id: `${groupName}-3`, p1: athletes[0].id, p2: athletes[1].id, score1: null, score2: null, sets: [] }
                ];
                state.standings[groupName] = athletes.map(a => ({ athleteId: a.id, played: 0, wins: 0, losses: 0, setsWon: 0, setsLost: 0 }));
            });
        }
        function initGroupsPhase() { renderGroupTabs(); renderGroupView(state.activeGroupTab); checkAllGroupMatchesPlayed(); }
        function renderGroupTabs() {
            groupTabsContainer.innerHTML = '';
            GROUP_NAMES.forEach(name => {
                const tab = document.createElement('div');
                tab.className = `tab ${state.activeGroupTab === name ? 'active' : ''}`;
                tab.textContent = `Grupo ${name}`;
                tab.dataset.group = name;
                tab.addEventListener('click', () => { state.activeGroupTab = name; saveState(); renderGroupTabs(); renderGroupView(name); });
                groupTabsContainer.appendChild(tab);
            });
        }
        function getAthleteById(id) { return state.athletes.find(a => a.id === id); }
        function renderGroupView(groupName) {
            const matches = state.groupMatches[groupName];
            groupMatchesContainer.innerHTML = '<h4>Partidas</h4>';
            matches.forEach(match => {
                const p1 = getAthleteById(match.p1); const p2 = getAthleteById(match.p2); const played = match.score1 !== null;
                groupMatchesContainer.innerHTML += `<div class="match-card ${played ? 'played' : ''}" data-match-id="${match.id}"><div class="match-players">${p1.name} (${p1.rank}º) vs ${p2.name} (${p2.rank}º)</div><div class="match-result">${played ? `${match.score1} - ${match.score2}` : '-'}</div></div>`;
            });
            groupMatchesContainer.querySelectorAll('.match-card:not(.played)').forEach(card => card.addEventListener('click', (e) => openMatchModal(e.currentTarget.dataset.matchId)));
            renderStandings(groupName);
        }
        function renderStandings(groupName) {
            calculateStandings(groupName);
            const standings = state.standings[groupName];
            groupStandingsContainer.innerHTML = `<h4>Classificação</h4><table class="standings-table"><thead><tr><th>Atleta</th><th>J</th><th>V</th><th>D</th><th>SV</th><th>SP</th><th>SG</th></tr></thead><tbody>${standings.map(s => { const athlete = getAthleteById(s.athleteId); return `<tr><td>${athlete.name} (${athlete.rank}º)</td><td>${s.played}</td><td>${s.wins}</td><td>${s.losses}</td><td>${s.setsWon}</td><td>${s.setsLost}</td><td>${s.setsWon - s.setsLost}</td></tr>`; }).join('')}</tbody></table>`;
        }
        function calculateStandings(groupName) {
            const matches = state.groupMatches[groupName]; const standings = state.standings[groupName];
            standings.forEach(s => { s.played=0; s.wins=0; s.losses=0; s.setsWon=0; s.setsLost=0; });
            matches.forEach(match => {
                if (match.score1 === null) return;
                const s1 = standings.find(s => s.athleteId === match.p1); const s2 = standings.find(s => s.athleteId === match.p2);
                s1.played++; s2.played++; s1.setsWon += match.score1; s1.setsLost += match.score2; s2.setsWon += match.score2; s2.setsLost += match.score1;
                if (match.score1 > match.score2) { s1.wins++; s2.losses++; } else { s2.wins++; s1.losses++; }
            });
            standings.sort((a, b) => {
                if (b.wins !== a.wins) return b.wins - a.wins;
                const tied = standings.filter(s => s.wins === a.wins);
                if (tied.length === 2) {
                    const h2h = matches.find(m => (m.p1 === a.athleteId && m.p2 === b.athleteId) || (m.p1 === b.athleteId && m.p2 === a.athleteId));
                    if (h2h?.score1 !== null) { return (h2h.p1 === a.athleteId && h2h.score1 > h2h.score2) || (h2h.p2 === a.athleteId && h2h.score2 > h2h.score1) ? -1 : 1; }
                }
                const diffA = a.setsWon - a.setsLost; const diffB = b.setsWon - b.setsLost;
                if (diffB !== diffA) return diffB - diffA; if (b.setsWon !== a.setsWon) return b.setsWon - a.setsWon;
                return getAthleteById(a.athleteId).rank - getAthleteById(b.athleteId).rank;
            });
        }
        function checkAllGroupMatchesPlayed() { finishGroupsBtn.classList.toggle('hidden', !Object.values(state.groupMatches).flat().every(m => m.score1 !== null)); }
        finishGroupsBtn.addEventListener('click', () => { state.currentPhase = 'elimination'; generateEliminationBracket(); saveState(); render(); });
        function generateEliminationBracket() {
            const qualifiers = [];
            GROUP_NAMES.forEach(groupName => { calculateStandings(groupName); qualifiers.push({ ...state.standings[groupName][0], pos: `1º ${groupName}` }); qualifiers.push({ ...state.standings[groupName][1], pos: `2º ${groupName}` }); });
            state.elimination.qualifiers = qualifiers;
            const getQ = (pos) => qualifiers.find(q => q.pos === pos).athleteId;
            state.elimination.sideA.quarterfinals = [ { id: 'A-QF-1', p1: getQ('1º A'), p2: getQ('2º H') }, { id: 'A-QF-2', p1: getQ('1º G'), p2: getQ('2º B') }, { id: 'A-QF-3', p1: getQ('1º D'), p2: getQ('2º E') }, { id: 'A-QF-4', p1: getQ('1º F'), p2: getQ('2º C') }, ].map(m => ({ ...m, score1: null, score2: null, sets: [] }));
            state.elimination.sideB.quarterfinals = [ { id: 'B-QF-1', p1: getQ('1º B'), p2: getQ('2º G') }, { id: 'B-QF-2', p1: getQ('1º H'), p2: getQ('2º A') }, { id: 'B-QF-3', p1: getQ('1º C'), p2: getQ('2º F') }, { id: 'B-QF-4', p1: getQ('1º E'), p2: getQ('2º D') }, ].map(m => ({ ...m, score1: null, score2: null, sets: [] }));
            state.elimination.sideA.semifinals = Array(2).fill(null).map((_, i) => ({ id: `A-SF-${i+1}`, p1: null, p2: null, score1: null, score2: null, sets: [] }));
            state.elimination.sideB.semifinals = Array(2).fill(null).map((_, i) => ({ id: `B-SF-${i+1}`, p1: null, p2: null, score1: null, score2: null, sets: [] }));
            state.elimination.sideA.final = [{ id: `A-F-1`, p1: null, p2: null, score1: null, score2: null, sets: [] }];
            state.elimination.sideB.final = [{ id: `B-F-1`, p1: null, p2: null, score1: null, score2: null, sets: [] }];
            state.elimination.overallFinal = [{ id: `Overall-F-1`, p1: null, p2: null, score1: null, score2: null, sets: [] }];
        }
        function initEliminationPhase() {
            renderEliminationRound('sideA', 'quarterfinals', 'matchesA-QF'); renderEliminationRound('sideA', 'semifinals', 'matchesA-SF'); renderEliminationRound('sideA', 'final', 'matchesA-F');
            renderEliminationRound('sideB', 'quarterfinals', 'matchesB-QF'); renderEliminationRound('sideB', 'semifinals', 'matchesB-SF'); renderEliminationRound('sideB', 'final', 'matchesB-F');
            renderEliminationRound(null, 'overallFinal', 'matchesFinal');
        }
        function renderEliminationRound(side, roundKey, containerId) {
            const container = document.getElementById(containerId); container.innerHTML = '';
            const matchesToRender = side ? state.elimination[side][roundKey] : state.elimination[roundKey];
            const renderMatchHTML = (match) => {
                const p1 = match.p1 ? getAthleteById(match.p1) : null; const p2 = match.p2 ? getAthleteById(match.p2) : null;
                const getQualifierInfo = (player) => { if (!player) return ''; const qualifier = state.elimination.qualifiers.find(q => q.athleteId === player.id); if (qualifier) return qualifier.pos.replace('º ', ''); return '(Vencedor)'; };
                const p1Display = p1 ? `${getQualifierInfo(p1)} - ${p1.name}` : 'A definir'; const p2Display = p2 ? `${getQualifierInfo(p2)} - ${p2.name}` : 'A definir';
                const played = match.score1 !== null; const winner = played ? (match.score1 > match.score2 ? match.p1 : match.p2) : null;
                return `<div class="elim-match ${played?'played':''} ${p1&&p2&&!played?'playable':''}" data-match-id="${match.id}"><div class="elim-match-player ${winner===p1?.id?'winner':''}"><span class="player-name">${p1Display}</span><span class="player-score">${played?match.score1:'-'}</span></div><div class="elim-match-player ${winner===p2?.id?'winner':''}"><span class="player-name">${p2Display}</span><span class="player-score">${played?match.score2:'-'}</span></div></div>`;
            };
            matchesToRender.forEach(match => container.innerHTML += renderMatchHTML(match));
            container.querySelectorAll('.elim-match.playable').forEach(card => card.addEventListener('click', (e) => openMatchModal(e.currentTarget.dataset.matchId)));
        }
        
        function advanceWinner(match) {
            if (match.score1 === null) return;
            const winnerId = match.score1 > match.score2 ? match.p1 : match.p2;
            const [side, matchType, matchIndexStr] = match.id.split('-');
            const matchIndex = parseInt(matchIndexStr) - 1;
            if (matchType === 'QF') {
                const sfIndex = Math.floor(matchIndex / 2);
                const sfPosition = (matchIndex % 2 === 0) ? 'p1' : 'p2';
                state.elimination[side === 'A' ? 'sideA' : 'sideB'].semifinals[sfIndex][sfPosition] = winnerId;
            } else if (matchType === 'SF') {
                const finalPosition = (matchIndex === 0) ? 'p1' : 'p2';
                state.elimination[side === 'A' ? 'sideA' : 'sideB'].final[0][finalPosition] = winnerId;
            }
            const finalA = state.elimination.sideA.final[0];
            const finalB = state.elimination.sideB.final[0];
            if (finalA.score1 !== null && finalB.score1 !== null && !state.elimination.overallFinal[0].p1) {
                const winnerA = finalA.score1 > finalA.score2 ? finalA.p1 : finalA.p2;
                const winnerB = finalB.score1 > finalB.score2 ? finalB.p1 : finalB.p2;
                state.elimination.overallFinal[0].p1 = winnerA;
                state.elimination.overallFinal[0].p2 = winnerB;
            }
            const overallFinalMatch = state.elimination.overallFinal[0];
            if (overallFinalMatch.score1 !== null) { state.currentPhase = 'results'; render(); }
        }

        function initResultsPhase() { renderFinalRanking(); }
        function calculateRanking() {
            const divisionPoints = POINTS_CONFIG[state.division];
            const finalA = state.elimination.sideA.final[0]; const finalB = state.elimination.sideB.final[0]; const overallFinal = state.elimination.overallFinal[0];
            const champion = overallFinal.score1 > overallFinal.score2 ? overallFinal.p1 : overallFinal.p2;
            const runnerUp = overallFinal.score1 < overallFinal.score2 ? overallFinal.p1 : overallFinal.p2;
            const thirdPlaceA = finalA.score1 < finalA.score2 ? finalA.p1 : finalA.p2; const thirdPlaceB = finalB.score1 < finalB.score2 ? finalB.p1 : finalB.p2;
            const quarterfinalists = [ ...state.elimination.sideA.semifinals.map(m => m.score1 < m.score2 ? m.p1 : m.p2), ...state.elimination.sideB.semifinals.map(m => m.score1 < m.score2 ? m.p1 : m.p2) ];
            const round16participants = [ ...state.elimination.sideA.quarterfinals.map(m => m.score1 < m.score2 ? m.p1 : m.p2), ...state.elimination.sideB.quarterfinals.map(m => m.score1 < m.score2 ? m.p1 : m.p2) ];
            return state.athletes.map(athlete => {
                let basePoints = 0; let bonusPoints = 0; let stage = 'Fase de Grupos';
                const allMatches = [...Object.values(state.groupMatches).flat(), ...state.elimination.sideA.quarterfinals, ...state.elimination.sideA.semifinals, ...state.elimination.sideA.final, ...state.elimination.sideB.quarterfinals, ...state.elimination.sideB.semifinals, ...state.elimination.sideB.final, ...state.elimination.overallFinal];
                allMatches.forEach(match => {
                    if (match.score1 === null || (match.p1 !== athlete.id && match.p2 !== athlete.id)) return;
                    const scoreKey = `${Math.max(match.score1, match.score2)}-${Math.min(match.score1, match.score2)}`;
                    if (POINTS_CONFIG.BONUS[scoreKey]) {
                        const isWinner = (match.p1 === athlete.id && match.score1 > match.score2) || (match.p2 === athlete.id && match.score2 > match.score1);
                        bonusPoints += isWinner ? POINTS_CONFIG.BONUS[scoreKey].winner : POINTS_CONFIG.BONUS[scoreKey].loser;
                    }
                });
                if (champion === athlete.id) { stage = 'Campeão'; basePoints = divisionPoints.CHAMPION; } 
                else if (runnerUp === athlete.id) { stage = 'Vice-Campeão'; basePoints = divisionPoints.RUNNER_UP; } 
                else if (thirdPlaceA === athlete.id || thirdPlaceB === athlete.id) { stage = '3º Lugar'; basePoints = divisionPoints.SEMIFINALS; }
                else if (quarterfinalists.includes(athlete.id)) { stage = 'Quartas de Final'; basePoints = divisionPoints.QUARTERFINALS; } 
                else if (round16participants.includes(athlete.id)) { stage = 'Oitavas de Final'; basePoints = divisionPoints.ROUND_16; } 
                else { stage = 'Fase de Grupos'; basePoints = divisionPoints.GROUP_STAGE; }
                return { id: athlete.id, name: athlete.name, points: basePoints + bonusPoints, basePoints, bonusPoints, stage };
            }).sort((a, b) => b.points - a.points);
        }
        function renderFinalRanking() {
            const ranking = calculateRanking();
            const champion = ranking[0] || {}; const runnerup = ranking[1] || {}; const thirdPlaces = ranking.filter(r => r.stage === '3º Lugar'); const thirdA = thirdPlaces[0] || {}; const thirdB = thirdPlaces[1] || {};
            document.querySelector('#champion .athlete-name').textContent = champion.name || '-'; document.querySelector('#champion .points').textContent = `${champion.points || 0} pts`;
            document.querySelector('#runnerup .athlete-name').textContent = runnerup.name || '-'; document.querySelector('#runnerup .points').textContent = `${runnerup.points || 0} pts`;
            document.querySelector('#third-a .athlete-name').textContent = thirdA.name || '-'; document.querySelector('#third-a .points').textContent = `${thirdA.points || 0} pts`;
            document.querySelector('#third-b .athlete-name').textContent = thirdB.name || '-'; document.querySelector('#third-b .points').textContent = `${thirdB.points || 0} pts`;
            const table = document.getElementById('finalRanking'); table.innerHTML = `<thead><tr><th>Pos.</th><th>Atleta</th><th>Pontos</th><th>Etapa</th></tr></thead><tbody>${ranking.map((r, i) => `<tr><td>${i+1}º</td><td>${r.name}</td><td>${r.points}</td><td>${r.stage}</td></tr>`).join('')}</tbody>`;
        }
        function openMatchModal(matchId) {
            let match; const [idPrefix, type] = matchId.split('-'); const roundKeyMap = { 'QF': 'quarterfinals', 'SF': 'semifinals', 'F': 'final' };
            if (GROUP_NAMES.includes(idPrefix)) { match = state.groupMatches[idPrefix].find(m => m.id === matchId); } 
            else if (idPrefix === 'A' || idPrefix === 'B') { match = state.elimination[idPrefix === 'A' ? 'sideA' : 'sideB'][roundKeyMap[type]].find(m => m.id === matchId); } 
            else if (idPrefix === 'Overall') { match = state.elimination.overallFinal.find(m => m.id === matchId); }
            if (!match || !match.p1 || !match.p2) return;
            state.currentMatch = match; const p1 = getAthleteById(match.p1), p2 = getAthleteById(match.p2);
            document.getElementById('modalAthlete1').textContent = `${p1.name} (${p1.rank}º)`; document.getElementById('modalAthlete2').textContent = `${p2.name} (${p2.rank}º)`;
            const setsGrid = document.getElementById('setsGrid'); setsGrid.innerHTML = `<div>${p1.name}</div><div></div><div>${p2.name}</div>`;
            for (let i = 0; i < 5; i++) { const set = match.sets[i] || { s1: '', s2: '' }; setsGrid.innerHTML += `<input type="number" class="set-input" data-set="${i}" data-player="1" min="0" value="${set.s1}"><div>Set ${i+1}</div><input type="number" class="set-input" data-set="${i}" data-player="2" min="0" value="${set.s2}">`; }
            document.getElementById('modalResult').textContent = ''; matchModal.classList.remove('hidden');
            setsGrid.querySelectorAll('input').forEach(input => input.addEventListener('input', calculateModalResult)); calculateModalResult();
        }
        function calculateModalResult() {
            let score1 = 0, score2 = 0, setsPlayed = 0;
            for (let i = 0; i < 5; i++) {
                const s1 = parseInt(document.querySelector(`.set-input[data-set="${i}"][data-player="1"]`).value) || 0; const s2 = parseInt(document.querySelector(`.set-input[data-set="${i}"][data-player="2"]`).value) || 0;
                if (s1 === 0 && s2 === 0 && document.querySelector(`.set-input[data-set="${i}"][data-player="1"]`).value === '' && document.querySelector(`.set-input[data-set="${i}"][data-player="2"]`).value === '') continue;
                setsPlayed++; if (s1 > s2 && (s1 >= 11 && s1 - s2 >= 2)) score1++; else if (s2 > s1 && (s2 >= 11 && s2 - s1 >= 2)) score2++;
            }
            document.getElementById('modalResult').textContent = `Placar: ${score1} - ${score2}`; saveResultBtn.disabled = !((score1 >= 3 || score2 >= 3) && (score1 + score2 === setsPlayed));
        }
        function saveMatchResult() {
            if (!state.currentMatch) return;
            let score1 = 0, score2 = 0, setsPlayed = 0, validSets = true; state.currentMatch.sets = [];
            for (let i = 0; i < 5; i++) {
                const s1 = parseInt(document.querySelector(`.set-input[data-set="${i}"][data-player="1"]`).value); const s2 = parseInt(document.querySelector(`.set-input[data-set="${i}"][data-player="2"]`).value);
                if (isNaN(s1) && isNaN(s2)) continue; if (isNaN(s1) || isNaN(s2) || s1 < 0 || s2 < 0) { validSets = false; break; }
                setsPlayed++; state.currentMatch.sets.push({ s1, s2 });
                if (s1 > s2 && (s1 >= 11 && s1 - s2 >= 2)) score1++; else if (s2 > s1 && (s2 >= 11 && s2 - s1 >= 2)) score2++; else validSets = false;
            }
            if (!validSets || (score1 < 3 && score2 < 3) || (score1 + score2 !== setsPlayed)) { showAlert('Resultado inválido. Verifique os pontos dos sets.'); return; }
            state.currentMatch.score1 = score1; state.currentMatch.score2 = score2; const [type] = state.currentMatch.id.split('-');
            if (GROUP_NAMES.includes(type)) { renderGroupView(state.activeGroupTab); checkAllGroupMatchesPlayed(); } else { advanceWinner(state.currentMatch); initEliminationPhase(); }
            saveState(); closeMatchModal();
        }
        function closeMatchModal() { state.currentMatch = null; matchModal.classList.add('hidden'); }
        closeModalBtn.addEventListener('click', closeMatchModal); cancelResultBtn.addEventListener('click', closeMatchModal); saveResultBtn.addEventListener('click', saveMatchResult);
        const genericModal = document.getElementById('genericModal'), genericModalTitle = document.getElementById('genericModalTitle'), genericModalMessage = document.getElementById('genericModalMessage'), genericModalConfirmBtn = document.getElementById('genericModalConfirmBtn'), genericModalCancelBtn = document.getElementById('genericModalCancelBtn'), genericModalClose = document.getElementById('genericModalClose');
        let confirmCallback = null;
        function showAlert(message, title = 'Aviso') { genericModalTitle.textContent = title; genericModalMessage.textContent = message; genericModalConfirmBtn.textContent = 'OK'; genericModalCancelBtn.classList.add('hidden'); genericModal.classList.remove('hidden'); confirmCallback = () => closeGenericModal(); }
        function showConfirm(message, title = 'Confirmação', onConfirm) { genericModalTitle.textContent = title; genericModalMessage.textContent = message; genericModalConfirmBtn.textContent = 'Confirmar'; genericModalCancelBtn.classList.remove('hidden'); genericModal.classList.remove('hidden'); confirmCallback = () => { onConfirm(); closeGenericModal(); }; }
        function closeGenericModal() { genericModal.classList.add('hidden'); confirmCallback = null; }
        genericModalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); }); genericModalCancelBtn.addEventListener('click', closeGenericModal); genericModalClose.addEventListener('click', closeGenericModal);
        
        const { jsPDF } = window.jspdf;
        function showToast(message, type = 'success') {
            const toast = document.getElementById('pdfToast');
            document.getElementById('toastMessage').textContent = message;
            toast.className = 'pdf-toast'; toast.classList.add(type);
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
        function getSafeFilename(name) { return (name.replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'torneio'); }
        function setupPdf(title, orientation = 'landscape') {
            const doc = new jsPDF({ orientation });
            const tournamentName = state.tournamentName || 'Torneio sem nome';
            const division = state.division;
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(20).text(tournamentName, doc.internal.pageSize.getWidth() / 2, 15, { align: 'center' });
            doc.setFontSize(14).text(division, doc.internal.pageSize.getWidth() / 2, 22, { align: 'center' });
            doc.setFontSize(16).text(title, doc.internal.pageSize.getWidth() / 2, 32, { align: 'center' });
            const pageHeight = doc.internal.pageSize.getHeight();
            doc.setFontSize(8); doc.setTextColor(150);
            doc.text('*Lembre-se que para qualquer relatório ser gerado com imagens, é necessária a autorização de imagem dos atletas para não violar as diretrizes de privacidade.', doc.internal.pageSize.getWidth() / 2, pageHeight - 10, { align: 'center' });
            doc.setTextColor(0);
            return doc;
        }
        
        document.getElementById('exportSetupBtn').addEventListener('click', () => {
            const doc = setupPdf('Lista de Inscritos por Ranking', 'portrait'); const body = state.athletes.map(a => [a.rank, a.name]);
            doc.autoTable({ head: [['Ranking', 'Nome do Atleta']], body: body, startY: 40 });
            doc.save(`inscritos_${getSafeFilename(state.tournamentName)}.pdf`); showToast('Lista de inscritos gerada!');
        });
        document.getElementById('exportGroupsBtn').addEventListener('click', () => {
            const doc = setupPdf('Grupos e Chaves', 'landscape'); const page_margin = 15; let startY = 40; const colGap = 70; const rowGap = 40;
            doc.setFontSize(12); doc.setFont('helvetica', 'bold');
            GROUP_NAMES.forEach((name, index) => {
                const group = state.groups[name]; const colIndex = index % 4; const rowIndex = Math.floor(index / 4);
                const xPos = page_margin + colIndex * colGap; const currentY = startY + rowIndex * rowGap;
                doc.text(`Grupo ${name}`, xPos, currentY); doc.setFont('helvetica', 'normal'); doc.setFontSize(10);
                group.forEach((athlete, athleteIndex) => { doc.text(`${athlete.rank}º - ${athlete.name}`, xPos, currentY + 8 + (athleteIndex * 7)); });
                doc.setFont('helvetica', 'bold'); doc.setFontSize(12);
            });
            doc.save(`grupos_${getSafeFilename(state.tournamentName)}.pdf`); showToast('PDF dos grupos gerado!');
        });
        document.getElementById('exportBracketBtn').addEventListener('click', () => {
            const doc = setupPdf('Chave Eliminatória', 'landscape'); let startY = 40;
            const rounds = { 'Lado A - Quartas': state.elimination.sideA.quarterfinals, 'Lado A - Semifinais': state.elimination.sideA.semifinals, 'Lado A - Final': state.elimination.sideA.final, 'Lado B - Quartas': state.elimination.sideB.quarterfinals, 'Lado B - Semifinais': state.elimination.sideB.semifinals, 'Lado B - Final': state.elimination.sideB.final, 'Final Geral': state.elimination.overallFinal };
            Object.entries(rounds).forEach(([title, matches]) => {
                if (!matches || matches.length === 0 || !matches.some(m => m.p1)) return;
                const body = matches.map(match => { const p1Name = match.p1 ? getAthleteById(match.p1).name : 'A definir'; const p2Name = match.p2 ? getAthleteById(match.p2).name : 'A definir'; const result = match.score1 !== null ? `${match.score1} x ${match.score2}` : '-'; return [`${p1Name}\nvs\n${p2Name}`, result]; });
                if (startY + (body.length * 15) > doc.internal.pageSize.getHeight() - 20) { doc.addPage(); startY = 40; }
                doc.autoTable({ head: [[title, 'Resultado']], body: body, startY: startY }); startY = doc.autoTable.previous.finalY + 15;
            });
            doc.save(`chave_eliminatoria_${getSafeFilename(state.tournamentName)}.pdf`); showToast('Chave eliminatória gerada!');
        });
        document.getElementById('exportRankingsBtn').addEventListener('click', () => {
            const doc = setupPdf('Ranking Final', 'landscape');
            doc.autoTable({ html: '#finalRanking', startY: 40 });
            doc.save(`ranking_final_${getSafeFilename(state.tournamentName)}.pdf`);
            showToast('Ranking final gerado!');
        });
        document.getElementById('exportCompleteBtn').addEventListener('click', () => {
            const doc = setupPdf('Relatório Final Completo', 'landscape'); let startY = 40; const tournamentName = getSafeFilename(state.tournamentName);
            doc.autoTable({ head: [[{ content: 'Lista de Inscritos', styles: { halign: 'center', fillColor: [52, 58, 64] } }]], startY: startY });
            const inscritosBody = state.athletes.map(a => [a.rank, a.name]);
            doc.autoTable({ head: [['Ranking', 'Nome do Atleta']], body: inscritosBody, startY: doc.autoTable.previous.finalY }); doc.addPage(); startY = 20;
            doc.autoTable({ head: [[{ content: 'Composição dos Grupos', styles: { halign: 'center', fillColor: [52, 58, 64] } }]], startY: startY }); startY = doc.autoTable.previous.finalY;
            GROUP_NAMES.forEach((name, index) => {
                const body = state.groups[name].map(a => [`${a.rank}º`, a.name]);
                if (startY > 150 && index % 2 === 0) { doc.addPage(); startY = 20; }
                doc.autoTable({ head: [[{content: `Grupo ${name}`, colSpan: 2, styles: {halign: 'center'}}]], body: body, startY: startY, theme: 'grid' }); startY = doc.autoTable.previous.finalY + 10;
            });
            doc.addPage(); startY = 20;
            const addResultsTable = (title, matches) => {
                if (startY > 180) { doc.addPage(); startY = 20; }
                const body = matches.filter(m => m.score1 !== null).map(match => {
                    const p1 = getAthleteById(match.p1); const p2 = getAthleteById(match.p2); const result = `${match.score1} x ${match.score2}`; const scoreKey = `${Math.max(match.score1, match.score2)}-${Math.min(match.score1, match.score2)}`;
                    const winnerBonus = POINTS_CONFIG.BONUS[scoreKey]?.winner || 0; const loserBonus = POINTS_CONFIG.BONUS[scoreKey]?.loser || 0;
                    const winner = match.score1 > match.score2 ? p1 : p2; const loser = match.score1 < match.score2 ? p1 : p2;
                    const points = `${winner.name}: +${winnerBonus}\n${loser.name}: +${loserBonus}`; return [`${p1.name} vs ${p2.name}`, result, formatSets(match.sets), points];
                });
                if (body.length > 0) {
                    doc.autoTable({ head: [[{ content: title, styles: { halign: 'center', fillColor: [52, 58, 64] } }]], startY: startY }); startY = doc.autoTable.previous.finalY;
                    doc.autoTable({ head: [['Partida', 'Resultado', 'Sets', 'Bônus (V/D)']], body: body, startY: startY }); startY = doc.autoTable.previous.finalY + 10;
                }
            };
            GROUP_NAMES.forEach(name => addResultsTable(`Resultados - Grupo ${name}`, state.groupMatches[name]));
            const elimMatches = { 'Lado A - Quartas': state.elimination.sideA.quarterfinals, 'Lado A - Semifinais': state.elimination.sideA.semifinals, 'Lado A - Final': state.elimination.sideA.final, 'Lado B - Quartas': state.elimination.sideB.quarterfinals, 'Lado B - Semifinais': state.elimination.sideB.semifinals, 'Lado B - Final': state.elimination.sideB.final, 'Final Geral': state.elimination.overallFinal};
            Object.entries(elimMatches).forEach(([title, matches]) => addResultsTable(`Resultados - ${title}`, matches));
            doc.addPage(); startY = 20; const ranking = calculateRanking();
            const rankingBody = ranking.map((r, i) => [`${i + 1}º`, r.name, r.basePoints, r.bonusPoints, r.points, r.stage]);
            doc.autoTable({ head: [[{ content: 'Ranking Final Detalhado', styles: { halign: 'center', fillColor: [52, 58, 64] } }]], startY: startY });
            doc.autoTable({ head: [['Pos.', 'Atleta', 'Pts. Base', 'Pts. Bônus', 'Total', 'Etapa']], body: rankingBody, startY: doc.autoTable.previous.finalY });
            doc.save(`relatorio_final_${getSafeFilename(state.tournamentName)}.pdf`); showToast('Relatório final completo gerado!');
        });
        function formatSets(sets) { if (!sets || sets.length === 0) return ''; return sets.map(set => `${set.s1}-${set.s2}`).join(', '); }
        function exportSummaries(rounds, title, filename) {
            const doc = setupPdf(title, 'landscape'); let startY = 40;
            const addSummaryToDoc = (matchTitle, match) => {
                if (!match || !match.p1) return; if (startY > 150) { doc.addPage(); startY = 20; }
                const p1 = getAthleteById(match.p1); const p2 = getAthleteById(match.p2); const body = match.sets.map((set, i) => [`Set ${i + 1}`, set.s1, set.s2]);
                doc.autoTable({ head: [[{ content: matchTitle, colSpan: 3, styles: { halign: 'center', fillColor: [52, 58, 64] } }]], body: [[`${p1.name} (${p1.rank}º)`, 'vs', `${p2.name} (${p2.rank}º)`]], startY: startY, theme: 'plain' });
                startY = doc.autoTable.previous.finalY;
                doc.autoTable({ head: [['Set', p1.name, p2.name]], body: body, startY: startY, theme: 'grid' }); startY = doc.autoTable.previous.finalY;
                doc.autoTable({ body: [[{content: `Resultado Final: ${match.score1} - ${match.score2}`, colSpan: 3, styles: { halign: 'center' }}]], startY: startY }); startY = doc.autoTable.previous.finalY + 15;
            };
            if (rounds.isGroup) { GROUP_NAMES.forEach(name => { state.groupMatches[name].filter(m => m.score1 !== null).forEach(match => addSummaryToDoc(`Grupo ${name}`, match)); }); }
            else if (rounds.isFinal) { state.elimination.overallFinal.filter(m => m.score1 !== null).forEach(match => addSummaryToDoc('Final Geral', match)); }
            else { Object.entries(rounds).forEach(([title, matches]) => { matches.filter(m => m.score1 !== null).forEach(match => addSummaryToDoc(title, match)); }); }
            doc.save(`${filename}_${getSafeFilename(state.tournamentName)}.pdf`); showToast(`${title} gerado!`);
        }
        document.getElementById('exportSumulasBtn').addEventListener('click', () => exportSummaries({isGroup: true}, 'Súmulas - Fase de Grupos', 'sumulas_grupos'));
        document.getElementById('exportSumulaEliminatoriaBtn').addEventListener('click', () => exportSummaries({ 'Lado A - Quartas': state.elimination.sideA.quarterfinals, 'Lado A - Semifinais': state.elimination.sideA.semifinals, 'Lado A - Final': state.elimination.sideA.final, 'Lado B - Quartas': state.elimination.sideB.quarterfinals, 'Lado B - Semifinais': state.elimination.sideB.semifinals, 'Lado B - Final': state.elimination.sideB.final }, 'Súmulas - Eliminatórias', 'sumulas_eliminatorias'));
        document.getElementById('exportSumulaFinalBtn').addEventListener('click', () => exportSummaries({isFinal: true}, 'Súmula da Final', 'sumulas_finais'));

        initAuth();
    });
    </script>
</body>
</html>
