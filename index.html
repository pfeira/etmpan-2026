<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GESTOR 08 GRUPOS - ETMPAN</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0D47A1">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Teko:wght@500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0D47A1; --primary-hover: #1565C0; --secondary-color: #1976D2;
            --accent-color: #FF5722; --danger-color: #B71C1C; --success-color: #28a745;
            --bg-color: #f7f8fc; --surface-color: #ffffff; --text-color: #424242;
            --text-muted: #6c757d; --border-color: #e0e0e0; --font-primary: 'Roboto', sans-serif;
            --font-display: 'Teko', sans-serif; --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.08); --border-radius: 12px;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font-primary); background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; overflow-x: hidden; }
        h1, h2, h3 { font-family: var(--font-display); letter-spacing: 1px; color: var(--primary-color); }
        #app { display: flex; min-height: 100vh; }
        .container { display: flex; width: 100%; }
        .sidebar { width: 280px; background-color: #fff; padding: 24px; display: flex; flex-direction: column; gap: 20px; position: fixed; height: 100%; overflow-y: auto; border-right: 1px solid var(--border-color); }
        .main-content { flex-grow: 1; margin-left: 280px; padding: 24px 32px; display: flex; flex-direction: column; gap: 24px; }
        .sidebar-section { border-top: 1px solid var(--border-color); padding-top: 20px; }
        .form-label, .pdf-section-title { display: block; margin-bottom: 8px; font-weight: 500; font-size: 0.9rem; }
        .form-control { width: 100%; padding: 10px 12px; background-color: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; font-size: 1rem; }
        .form-control:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(13, 71, 161, 0.2); }
        .pdf-buttons { display: flex; flex-direction: column; gap: 10px; }
        .btn { display: inline-flex; align-items: center; justify-content: center; padding: 12px 18px; font-size: 1rem; font-weight: 500; border-radius: var(--border-radius); cursor: pointer; transition: all 0.2s ease-out; border: none; color: white; }
        .btn--primary { background: linear-gradient(145deg, #1565C0, #0D47A1); }
        .btn--accent { background: linear-gradient(145deg, #FF5722, #F44336); }
        .btn--secondary { background-color: var(--surface-color); color: var(--text-color); border: 1px solid var(--border-color); }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .hidden { display: none !important; }
        .phase-indicator { display: flex; justify-content: space-around; background: #fff; padding: 16px; border-radius: var(--border-radius); box-shadow: var(--shadow-sm); }
        .phase { display: flex; align-items: center; gap: 10px; opacity: 0.5; position: relative; flex: 1; justify-content: center; }
        .phase-number { width: 32px; height: 32px; border-radius: 50%; background-color: var(--bg-color); border: 2px solid var(--border-color); display: grid; place-items: center; font-weight: bold; }
        .phase.phase-active { opacity: 1; }
        .phase.phase-active .phase-number { border-color: var(--primary-color); color: var(--primary-color); }
        .phase.phase-complete .phase-number { border-color: var(--success-color); background-color: var(--success-color); color: white; }
        .phase-content { background: #fff; padding: 24px; border-radius: var(--border-radius); box-shadow: var(--shadow-md); }
        .phase-content h2 { font-size: 2rem; margin-bottom: 20px; border-bottom: 2px solid var(--primary-color); padding-bottom: 10px; }
        .athletes-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .groups-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-top: 20px; }
        .elimination-container { display: flex; gap: 32px; overflow-x: auto; padding: 16px; background-color: var(--bg-color); border-radius: var(--border-radius); }
        .elimination-side { flex: 1; min-width: 500px; }
        .elimination-side > h3 { text-align: center; margin-bottom: 16px; font-size: 2rem; }
        .elimination-rounds { display: flex; gap: 20px; padding-bottom: 16px; }
        .round { display: flex; flex-direction: column; gap: 30px; min-width: 280px; flex: 1; }
        .round h4 { text-align: center; font-size: 1.5rem; color: var(--secondary-color); }
        .elim-match { background-color: #fff; border-radius: var(--border-radius); border: 1px solid var(--border-color); cursor: pointer; box-shadow: var(--shadow-sm); }
        .elim-match.played { cursor: default; }
        .elim-match.winner .player-name { font-weight: bold; color: var(--success-color); }
        .elim-match-player { display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; }
        .elim-match-player:first-child { border-bottom: 1px solid var(--border-color); }
        .final-match-container { margin-top: 32px; padding-top: 24px; border-top: 2px dashed var(--accent-color); }
        .final-match-container h3 { text-align: center; font-size: 2rem; color: var(--accent-color); }
        .podium { display: flex; justify-content: center; align-items: flex-end; gap: 20px; margin: 40px 0; text-align: center; }
        .position { width: 200px; padding: 20px; border-radius: var(--border-radius); background: #fff; box-shadow: var(--shadow-md); }
        #champion { order: 2; height: 200px; } #runnerup { order: 1; height: 160px; }
        #third-place-container { order: 3; display: flex; gap: 10px; align-items: flex-end; }
        #third-place-container .position { width: 160px; height: 130px; }
        .modal { position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #fff; border-radius: var(--border-radius); width: 90%; max-width: 600px; box-shadow: var(--shadow-md); }
        .modal-header { padding: 16px 24px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--text-muted); }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--border-color); display: flex; justify-content: flex-end; gap: 12px; }
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--bg-color); z-index: 5000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 100%; max-width: 400px; padding: 40px; background-color: #fff; box-shadow: var(--shadow-md); border-radius: var(--border-radius); text-align: center; }
        #login-error { color: var(--danger-color); margin-top: 10px; font-size: 0.9rem; height: 1.2rem; }
        @media (max-width: 768px) { .main-content { margin-left: 0; } .sidebar { position: static; width: 100%; height: auto; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <img src="etmpan1.jpg.jpg" alt="Logo ETMPAN" style="width: 100px; height: auto; margin-bottom: 1rem; border-radius: 8px;">
            <h2 style="font-size: 2.5rem; margin-bottom: 2rem;">Acesso ao Gestor</h2>
            <input type="text" id="username" class="form-control" placeholder="Usuário" style="margin-bottom: 1rem;">
            <input type="password" id="password" class="form-control" placeholder="Senha" style="margin-bottom: 1rem;">
            <button id="loginBtn" class="btn btn--primary" style="width: 100%;">Entrar</button>
            <p id="login-error"></p>
        </div>
    </div>

    <div id="app" class="hidden">
        <div class="container">
            <aside class="sidebar">
                 <div class="text-center mb-4">
                    <img src="etmpan1.jpg.jpg" alt="Logo ETMPAN" style="width: 112px; height: auto; border-radius: .5rem; margin: auto;">
                    <h1 style="font-size: 2.25rem; font-weight: 700; color: var(--primary-color); letter-spacing: .05em; margin-top: .5rem;">GESTOR 08</h1>
                </div>
                <div class="sidebar-section">
                    <label for="divisionSelector" class="form-label">Divisão Ativa</label>
                    <select id="divisionSelector" class="form-control">
                        <option value="1ª Div.">1ª Div.</option>
                        <option value="2ª Div.">2ª Div.</option>
                        <option value="3ª Div.">3ª Div.</option>
                    </select>
                </div>
                <div class="sidebar-section">
                    <label for="tournamentName" class="form-label">Nome do Torneio</label>
                    <input type="text" id="tournamentName" class="form-control" placeholder="Digite o nome do torneio">
                </div>
                <div class="sidebar-section">
                    <h3 class="pdf-section-title">Exportar PDFs</h3>
                    <div class="pdf-buttons">
                        <button id="exportSetupBtn" class="btn btn--primary" style="width: 100%;" disabled>Lista de Inscritos</button>
                        <button id="exportGroupsBtn" class="btn btn--primary" style="width: 100%;" disabled>Grupos e Chaves</button>
                        <button id="exportBracketBtn" class="btn btn--primary" style="width: 100%;" disabled>Chave Eliminatória</button>
                        <button id="exportRankingsBtn" class="btn btn--primary" style="width: 100%;" disabled>Ranking Final</button>
                        <button id="exportCompleteBtn" class="btn btn--accent" style="width: 100%;" disabled>Relatório Completo</button>
                        <button id="exportSumulasBtn" class="btn btn--secondary" style="width: 100%;" disabled>Súmulas dos Grupos</button>
                        <button id="exportSumulaEliminatoriaBtn" class="btn btn--secondary" style="width: 100%;" disabled>Súmulas Eliminatórias</button>
                        <button id="exportSumulaFinalBtn" class="btn btn--secondary" style="width: 100%;" disabled>Súmula da Final</button>
                    </div>
                </div>
                <div class="sidebar-section">
                    <button id="resetBtn" class="btn btn--secondary" style="width: 100%;">Resetar Torneio Atual</button>
                    <button id="logoutBtn" class="btn btn--secondary" style="width: 100%; margin-top: 10px; border-color: var(--danger-color); color: var(--danger-color);">Sair (Logout)</button>
                </div>
            </aside>
            <main class="main-content">
                <div class="phase-indicator">
                    <div class="phase" data-phase="setup"><span class="phase-number">1</span><span class="phase-name">Configuração</span></div>
                    <div class="phase" data-phase="groups"><span class="phase-number">2</span><span class="phase-name">Fase de Grupos</span></div>
                    <div class="phase" data-phase="elimination"><span class="phase-number">3</span><span class="phase-name">Eliminatórias</span></div>
                    <div class="phase" data-phase="results"><span class="phase-number">4</span><span class="phase-name">Resultados</span></div>
                </div>
                <section id="setup-phase" class="phase-content">
                    <h2>Configuração do Torneio</h2>
                    <div class="setup-form">
                        <h3>Cadastro de Atletas (24 posições por ranking)</h3>
                        <div class="athletes-grid" id="athletesGrid"></div>
                        <button id="generateGroupsBtn" class="btn btn--primary">Gerar Grupos</button>
                    </div>
                    <div id="groupsDisplay" class="groups-display hidden">
                        <h3>Distribuição dos Grupos</h3>
                        <div class="groups-grid" id="groupsGrid"></div>
                        <button id="startTournamentBtn" class="btn btn--accent">Iniciar Torneio</button>
                    </div>
                </section>
                <section id="groups-phase" class="phase-content hidden">
                    <h2>Fase de Grupos</h2>
                    <div id="groupTabs"></div>
                    <div id="group-content-container"></div>
                </section>
                <section id="elimination-phase" class="phase-content hidden">
                     <h2>Fase Eliminatória</h2>
                    <div class="elimination-container">
                        <div class="elimination-side" id="sideA">
                            <h3>LADO A</h3>
                            <div class="elimination-rounds">
                                <div class="round"><h4>Quartas de Final</h4><div id="matchesA-QF"></div></div>
                                <div class="round"><h4>Semifinais</h4><div id="matchesA-SF"></div></div>
                                <div class="round"><h4>Final Lado A</h4><div id="matchesA-F"></div></div>
                            </div>
                        </div>
                        <div class="elimination-side" id="sideB">
                            <h3>LADO B</h3>
                            <div class="elimination-rounds">
                                <div class="round"><h4>Quartas de Final</h4><div id="matchesB-QF"></div></div>
                                <div class="round"><h4>Semifinais</h4><div id="matchesB-SF"></div></div>
                                <div class="round"><h4>Final Lado B</h4><div id="matchesB-F"></div></div>
                            </div>
                        </div>
                    </div>
                    <div class="final-match-container">
                        <h3>FINAL GERAL</h3>
                        <div class="elimination-rounds" style="justify-content: center;"><div class="round"><div id="matchesFinal"></div></div></div>
                    </div>
                </section>
                <section id="results-phase" class="phase-content hidden">
                    <h2>Resultados Finais</h2>
                    <div class="final-results">
                        <div class="podium">
                             <div class="position" id="runnerup"><div style="width:60px;height:60px;border-radius:50%;margin:0 auto;border:3px solid #ababab;background:#c0c0c0;"></div><div>Vice-Campeão</div><div class="points"></div></div>
                            <div class="position" id="champion"><div style="width:60px;height:60px;border-radius:50%;margin:0 auto;border:3px solid #e6c200;background:#ffd700;"></div><div>Campeão</div><div class="points"></div></div>
                            <div id="third-place-container">
                                <div class="position"><div>3º Lugar</div><div class="athlete-name"></div><div class="points"></div></div>
                                <div class="position"><div>3º Lugar</div><div class="athlete-name"></div><div class="points"></div></div>
                            </div>
                        </div>
                        <div class="final-ranking">
                            <h3>Classificação Final</h3>
                            <table id="finalRanking" style="width: 100%; border-collapse: collapse;"></table>
                        </div>
                    </div>
                </section>
            </main>
        </div>
        <div id="matchModal" class="modal hidden">
            <div class="modal-content">
                <div class="modal-header"><h3 id="modalTitle">Resultado da Partida</h3><button id="closeModal" class="modal-close">&times;</button></div>
                <div class="modal-body"></div>
                <div class="modal-footer"><button id="saveResult" class="btn btn--primary">Salvar</button><button id="cancelResult" class="btn btn--secondary">Cancelar</button></div>
            </div>
        </div>
    </div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js').then(registration => {
                    console.log('ServiceWorker: Registro bem-sucedido. Escopo:', registration.scope);
                }).catch(error => {
                    console.log('ServiceWorker: Falha no registro.', error);
                });
            });
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const APP_VERSION = "2.2"; 
            let appState = {}; 
            let state = {}; 

            function getInitialTournamentState(division) {
                return {
                    appVersion: APP_VERSION, tournamentName: '', division: division,
                    currentPhase: 'setup', athletes: [], groups: {}, groupMatches: {}, standings: {},
                    elimination: { qualifiers: [], sideA: { quarterfinals: [], semifinals: [], final: [] }, sideB: { quarterfinals: [], semifinals: [], final: [] }, overallFinal: [] },
                    activeGroupTab: 'A', currentMatch: null,
                };
            }

            function getInitialAppState() {
                return {
                    appVersion: APP_VERSION, loggedIn: false, activeDivision: '1ª Div.',
                    tournaments: {
                        '1ª Div.': getInitialTournamentState('1ª Div.'),
                        '2ª Div.': getInitialTournamentState('2ª Div.'),
                        '3ª Div.': getInitialTournamentState('3ª Div.'),
                    }
                };
            }

            const NUM_ATHLETES = 24;
            const GROUP_NAMES = ['A', 'B', 'C', 'D', 'E', 'F', 'G', 'H'];
            
            const loginScreen = document.getElementById('login-screen');
            const appContainer = document.getElementById('app');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const divisionSelector = document.getElementById('divisionSelector');
            const tournamentNameInput = document.getElementById('tournamentName');
            const resetBtn = document.getElementById('resetBtn');

            function initAuth() {
                loadState(); 
                if (appState.loggedIn) {
                    loginScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    init();
                } else {
                    loginScreen.classList.remove('hidden');
                    appContainer.classList.add('hidden');
                }
            }

            function handleLogin() {
                const user = document.getElementById('username').value;
                const pass = document.getElementById('password').value;
                const errorEl = document.getElementById('login-error');
                if (user === 'admin' && pass === 'admin123') {
                    appState.loggedIn = true;
                    saveState();
                    initAuth();
                } else {
                    errorEl.textContent = 'Usuário ou senha inválidos.';
                }
            }

            function handleLogout() {
                appState.loggedIn = false;
                saveState();
                initAuth();
            }

            loginBtn.addEventListener('click', handleLogin);
            document.getElementById('password').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            logoutBtn.addEventListener('click', handleLogout);

            function saveState() { localStorage.setItem('gestorAppState', JSON.stringify(appState)); }
            function loadState() {
                const savedStateJSON = localStorage.getItem('gestorAppState');
                if (savedStateJSON) {
                    const savedState = JSON.parse(savedStateJSON);
                    if (savedState.appVersion === APP_VERSION) {
                        appState = savedState;
                        return;
                    }
                }
                appState = getInitialAppState();
            }
            
            function resetState() {
                showConfirm(`Tem certeza que deseja resetar o torneio da ${appState.activeDivision}?`, 'Resetar Torneio',
                    () => {
                        appState.tournaments[appState.activeDivision] = getInitialTournamentState(appState.activeDivision);
                        saveState();
                        render();
                    }
                );
            }
            resetBtn.addEventListener('click', resetState);

            function init() {
                state = appState.tournaments[appState.activeDivision];
                divisionSelector.value = appState.activeDivision;
                divisionSelector.removeEventListener('change', switchDivision);
                divisionSelector.addEventListener('change', switchDivision);
                
                tournamentNameInput.removeEventListener('input', updateTournamentName);
                tournamentNameInput.addEventListener('input', updateTournamentName);
                
                render();
            }
            
            function switchDivision(e) {
                appState.activeDivision = e.target.value;
                saveState();
                init(); 
            }

            function updateTournamentName(e) {
                state.tournamentName = e.target.value;
                saveState();
            }

            function render() {
                state = appState.tournaments[appState.activeDivision];
                tournamentNameInput.value = state.tournamentName;
                
                const phaseContents = document.querySelectorAll('.phase-content');
                const phaseIndicator = document.querySelector('.phase-indicator');
                
                phaseIndicator.querySelectorAll('.phase').forEach(phaseEl => {
                    const phaseName = phaseEl.dataset.phase;
                    phaseEl.classList.remove('phase-active', 'phase-complete');
                    const phasesOrder = ['setup', 'groups', 'elimination', 'results'];
                    const currentIndex = phasesOrder.indexOf(state.currentPhase);
                    const phaseIndex = phasesOrder.indexOf(phaseName);
                    if (phaseIndex < currentIndex) { phaseEl.classList.add('phase-complete'); } 
                    else if (phaseIndex === currentIndex) { phaseEl.classList.add('phase-active'); }
                });

                phaseContents.forEach(content => {
                    content.classList.add('hidden');
                    if (content.id === `${state.currentPhase}-phase`) {
                        content.classList.remove('hidden');
                    }
                });

                // Render specific phase
                // This part needs to be filled based on the specific logic for each phase
            }
            
            // Placeholder for a generic alert/confirm modal
            function showConfirm(message, title, callback) {
                if(confirm(`${title}: ${message}`)) {
                    callback();
                }
            }

            initAuth();
        });
    </script>
</body>
</html>